#!/usr/bin/env bash
set -euo pipefail
cd "$(git rev-parse --show-toplevel)"

echo "==> verify: start"

status_entries=()
while IFS= read -r -d '' entry; do
  status_entries+=("$entry")
done < <(git status --porcelain -z)
if (( ${#status_entries[@]} == 0 )); then
  echo "==> verify: no changes; skipping"
  exit 0
fi

has_python=0
has_swift=0
has_rust=0
sh_files=()
bicep_files=()

for entry in "${status_entries[@]}"; do
  if [[ "$entry" == *" "* ]]; then
    path="${entry#?? }"
  else
    path="$entry"
  fi
  case "$path" in
    *.py|pyproject.toml|requirements.txt) has_python=1 ;;
    *.swift|Package.swift|*.xcodeproj|*.xcscheme) has_swift=1 ;;
    *.rs|Cargo.toml) has_rust=1 ;;
    *.sh) sh_files+=("$path") ;;
    *.bicep) bicep_files+=("$path") ;;
  esac
done

ran=0

have_cmd() { command -v "$1" >/dev/null 2>&1; }
skip_cmd() { echo "==> $1: $2 not installed; skipping"; }

if (( has_python == 1 )); then
  if have_cmd python; then
    if python -m pytest --version >/dev/null 2>&1; then
      echo "==> python: pytest"
      set +e
      python -m pytest -q
      status=$?
      set -e
      if [[ "$status" -eq 0 ]]; then
        ran=1
      elif [[ "$status" -eq 5 ]]; then
        echo "==> python: pytest: no tests collected; skipping"
      else
        exit 1
      fi
    else
      skip_cmd "python" "pytest"
    fi
  else
    skip_cmd "python" "python"
  fi
fi

if (( has_swift == 1 )); then
  if have_cmd swift; then
    if [[ -f Package.swift ]]; then
      echo "==> swift: swift test"
      swift test && ran=1 || exit 1
    else
      echo "==> swift: Package.swift not found; skipping swift test"
    fi
  else
    skip_cmd "swift" "swift"
  fi
fi

if (( has_swift == 1 )); then
  if have_cmd xcodebuild; then
    project="$(find . -maxdepth 2 -name "*.xcodeproj" -print -quit)"
    if [[ -n "$project" ]]; then
      scheme="SolixMenu"
      echo "==> xcodebuild: $project (scheme $scheme)"
      xcodebuild -project "$project" -scheme "$scheme" -configuration Debug build && ran=1 || exit 1
    else
      echo "==> xcodebuild: no .xcodeproj found; skipping"
    fi
  else
    skip_cmd "xcodebuild" "xcodebuild"
  fi
fi

if (( has_rust == 1 )); then
  if have_cmd cargo; then
    echo "==> rust: cargo test"
    cargo test && ran=1 || exit 1
  else
    skip_cmd "rust" "cargo"
  fi
fi

if (( ${#sh_files[@]} > 0 )); then
  if have_cmd shellcheck; then
    echo "==> bash: shellcheck"
    shellcheck "${sh_files[@]}" && ran=1 || exit 1
  else
    skip_cmd "bash" "shellcheck"
  fi
fi

if (( ${#bicep_files[@]} > 0 )); then
  if have_cmd az; then
    echo "==> bicep: az bicep lint"
    for bicep_file in "${bicep_files[@]}"; do
      az bicep lint -f "$bicep_file" && ran=1 || exit 1
    done
  elif have_cmd bicep; then
    echo "==> bicep: bicep lint"
    for bicep_file in "${bicep_files[@]}"; do
      bicep lint "$bicep_file" && ran=1 || exit 1
    done
  else
    skip_cmd "az/bicep" "az/bicep"
  fi
fi

if [[ "$ran" -eq 0 ]]; then
  echo "WARN: No known test/build targets detected. Add checks to .zed/scripts/verify."
fi

echo "==> verify: OK"
